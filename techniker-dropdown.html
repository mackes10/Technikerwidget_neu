<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Techniker Dropdown</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 10px;
    }
    select {
      width: 100%;
      padding: 8px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <label for="technikerDropdown">Techniker auswählen:</label>
  <select id="technikerDropdown">
    <option>Bitte Dienstleister wählen</option>
  </select>

  <script>
    let technikerData = [];

    // Techniker laden
    async function loadTechnikerJSON() {
      try {
        const response = await fetch("https://mackes10.github.io/Technikerwidget_neu/techniker.json");
        if (!response.ok) throw new Error("Fehler beim Laden der JSON");
        technikerData = await response.json();
        console.log("Techniker-Daten geladen:", technikerData);
      } catch (error) {
        console.error("Fehler beim Laden der Techniker:", error);
      }
    }

    // Dropdown füllen
    function filterTechniker(dienstleister) {
      const dropdown = document.getElementById("technikerDropdown");
      dropdown.innerHTML = "";

      const gefiltert = technikerData.filter(t => t.dienstleister.toLowerCase() === dienstleister.toLowerCase());

      if (gefiltert.length === 0) {
        const option = document.createElement("option");
        option.text = "Keine Techniker gefunden";
        dropdown.add(option);
        return;
      }

      const placeholder = document.createElement("option");
      placeholder.text = "Bitte Techniker wählen";
      dropdown.add(placeholder);

      gefiltert.forEach(techniker => {
        const option = document.createElement("option");
        option.value = techniker.name;
        option.text = techniker.name;
        dropdown.add(option);
      });
    }

    // Initialisierung des Widgets
    async function initWidget() {
      await loadTechnikerJSON();

      if (typeof JFCustomWidget === "undefined") {
        console.error("JFCustomWidget ist nicht definiert. Läuft das im Jotform-Widget?");
        return;
      }

      // Dienstleister auslesen und Dropdown füllen
      JFCustomWidget.getField("dienstleister", function(value) {
        console.log("Dienstleister-Feldwert:", value);
        if (value) {
          filterTechniker(value);
        }
      });

      // Änderungen überwachen (wenn z. B. auf der Seite geändert wird)
      window.addEventListener("message", function (e) {
        if (e.data?.type === "widget-comms" && e.data?.name === "dienstleister") {
          const neuerWert = e.data.value;
          console.log("Dienstleister geändert auf:", neuerWert);
          filterTechniker(neuerWert);
        }
      });

      // Wert im Dropdown an Jotform zurückmelden
      document.getElementById("technikerDropdown").addEventListener("change", function () {
        const value = this.value;
        console.log("Ausgewählter Techniker:", value);
        JFCustomWidget.sendData({ value });
      });

      // Widget-Resizing aktivieren
      JFCustomWidget.setHeight(60);
    }

    // Warte, bis alles geladen ist
    window.addEventListener("load", function () {
      // Warten auf JFCustomWidget
      const checkInterval = setInterval(() => {
        if (typeof JFCustomWidget !== "undefined") {
          clearInterval(checkInterval);
          initWidget();
        }
      }, 100);
    });
  </script>
</body>
</html>
