<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Techniker Dropdown Widget (filter nach Dienstleister)</title>
  <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
    }
    #main {
      width: 100%;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    select {
      width: 100%;
      padding: 8px;
      font-size: 1em;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="main">
    <label for="technikerSelect">Techniker auswählen:</label>
    <select id="technikerSelect">
      <option value="">Bitte Dienstleister auswählen</option>
    </select>
  </div>

  <script>
    (function() {
      var select = document.getElementById('technikerSelect');
      var jsonUrl = 'https://mackes10.github.io/Technikerwidget_neu/techniker.json';

      // Funktion, die Techniker lädt und das Dropdown füllt, gefiltert nach Dienstleister
      function loadTechniker(dienstleister) {
        if (!dienstleister) {
          select.innerHTML = '<option value="">Bitte Dienstleister auswählen</option>';
          JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight });
          return;
        }

        fetch(jsonUrl + '?t=' + Date.now())
          .then(function(res) {
            if (!res.ok) throw new Error('Netzwerkantwort war nicht OK');
            return res.json();
          })
          .then(function(technikerArray) {
            // Filtere Techniker nach Dienstleister
            var gefilterteTechniker = technikerArray.filter(function(t) {
              return t.dienstleister && t.dienstleister.toLowerCase() === dienstleister.toLowerCase();
            });

            // Dropdown füllen
            select.innerHTML = '';
            if (gefilterteTechniker.length === 0) {
              select.innerHTML = '<option value="">Keine Techniker gefunden</option>';
            } else {
              gefilterteTechniker.forEach(function(t) {
                var opt = document.createElement('option');
                opt.value = t.name;
                opt.textContent = t.name;
                select.appendChild(opt);
              });
            }

            JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight });
          })
          .catch(function(err) {
            console.error('Fehler beim Laden der Techniker-Liste:', err);
            select.innerHTML = '<option value="">Liste konnte nicht geladen werden</option>';
            JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight });
          });
      }

      // Sobald Widget bereit ist
      JFCustomWidget.subscribe("ready", function() {
        // Dienstleister-Feld finden
        var dienstleisterFeld = JFCustomWidget.getField('dienstleister');

        if (!dienstleisterFeld) {
          console.warn('Dienstleister-Feld nicht gefunden');
          select.innerHTML = '<option value="">Dienstleister-Feld nicht gefunden</option>';
          return;
        }

        // Initial Techniker laden
        loadTechniker(dienstleisterFeld.value);

        // Auf Änderung im Dienstleister-Feld hören
        dienstleisterFeld.addEventListener('input', function() {
          loadTechniker(this.value);
          // Eventuelle Änderung ans Formular senden
          JFCustomWidget.sendData({ value: '' }); // Leeren, da noch kein Techniker gewählt
        });
      });

      // Beim Dropdown-Wechsel Wert ans Formular senden
      select.addEventListener('change', function() {
        JFCustomWidget.sendData({ value: this.value });
      });

      // Beim Submit den Wert mitgeben
      JFCustomWidget.subscribe("submit", function() {
        JFCustomWidget.sendSubmit({
          valid: true,
          value: select.value
        });
      });
    })();
  </script>
</body>
</html>
