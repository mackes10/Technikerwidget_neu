<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Techniker Dropdown</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
    }
    label {
      display: block;
      margin-bottom: 5px;
    }
    select {
      width: 100%;
      padding: 8px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <label for="techniker">Techniker auswählen:</label>
  <select id="techniker">
    <option value="">Bitte Dienstleister wählen</option>
  </select>

  <script src="https://cdn.jotfor.ms/widgets/jotformCustomWidget.min.js"></script>
  <script>
    let technikerData = [];

    // Lädt Techniker-JSON von GitHub
    async function loadTechnikerJSON() {
      try {
        const response = await fetch("https://mackes10.github.io/Technikerwidget_neu/techniker.json");
        if (!response.ok) throw new Error("Fehler beim Laden der Technikerliste");
        technikerData = await response.json();
      } catch (error) {
        console.error("Fehler beim Laden der Techniker-JSON:", error);
      }
    }

    // Filtert Techniker nach Dienstleister
    function filterTechniker(dienstleister) {
      const dropdown = document.getElementById("techniker");
      dropdown.innerHTML = ""; // Leeren

      const technikerListe = technikerData.filter(t => t.dienstleister.toLowerCase() === dienstleister.toLowerCase());

      if (technikerListe.length === 0) {
        const option = document.createElement("option");
        option.text = "Keine Techniker gefunden";
        option.disabled = true;
        dropdown.add(option);
        return;
      }

      // Standardoption
      const optionDefault = document.createElement("option");
      optionDefault.value = "";
      optionDefault.text = "Bitte Techniker auswählen";
      dropdown.add(optionDefault);

      // Optionen hinzufügen
      technikerListe.forEach(t => {
        const option = document.createElement("option");
        option.value = t.name;
        option.text = t.name;
        dropdown.add(option);
      });

      // Widget-Wert setzen
      JFCustomWidget.setValue(dropdown.value || "");
    }

    async function initWidget() {
      await loadTechnikerJSON();

      // Initial: Dienstleister-Feld lesen
      JFCustomWidget.getField("dienstleister", function(value) {
        if (value) {
          filterTechniker(value);
        }
      });

      // Bei Änderungen am Dienstleister-Feld neu filtern
      JFCustomWidget.subscribe("fieldChanged", function(data) {
        if (data.name === "dienstleister") {
          filterTechniker(data.value);
        }
      });

      // Technikerwahl im Dropdown → Widget-Wert setzen
      document.getElementById("techniker").addEventListener("change", function () {
        JFCustomWidget.setValue(this.value);
      });

      JFCustomWidget.ready();
    }

    initWidget();
  </script>
</body>
</html>
