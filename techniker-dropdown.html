<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Techniker Dropdown Widget (nach Dienstleister)</title>
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 10px;
      }
      #main {
        width: 100%;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      select {
        width: 100%;
        padding: 8px;
        font-size: 1em;
        box-sizing: border-box;
      }
    </style>
  </head>
  <body>
    <div id="main">
      <label for="technikerSelect">Techniker auswählen:</label>
      <select id="technikerSelect">
        <option value="">Lade Techniker…</option>
      </select>
    </div>

    <script type="text/javascript">
      (function(){
        var select = document.getElementById('technikerSelect');
        var jsonUrl = 'https://mackes10.github.io/Technikerwidget_neu/techniker.json';

        // Funktion zum Laden und Filtern
        function loadTechniker(callback) {
          JFCustomWidget.getField("dienstleister", function(dienstleisterWert) {
            // JSON laden
            fetch(jsonUrl + '?t=' + Date.now())
              .then(function(res){
                if (!res.ok) throw new Error('Netzwerkantwort war nicht OK');
                return res.json();
              })
              .then(function(technikerArray){
                var previous = select.value;
                select.innerHTML = '';

                // Filtern nach Dienstleister
                var gefilterteTechniker = technikerArray.filter(function(eintrag){
                  return eintrag.dienstleister === dienstleisterWert;
                });

                if (gefilterteTechniker.length === 0) {
                  var opt = document.createElement('option');
                  opt.value = '';
                  opt.textContent = 'Keine Techniker gefunden';
                  select.appendChild(opt);
                } else {
                  gefilterteTechniker.forEach(function(eintrag){
                    var opt = document.createElement('option');
                    opt.value = eintrag.name;
                    opt.textContent = eintrag.name;
                    select.appendChild(opt);
                  });

                  if (gefilterteTechniker.some(e => e.name === previous)) {
                    select.value = previous;
                  } else {
                    select.value = gefilterteTechniker[0].name;
                  }
                }

                if (typeof callback === 'function') callback(select.value);
                JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight });
              })
              .catch(function(err){
                console.error('Fehler beim Laden der Techniker‑Liste:', err);
                select.innerHTML = '<option value="">Liste konnte nicht geladen werden</option>';
                JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight });
              });
          });
        }

        // Initiales Laden beim Start
        JFCustomWidget.subscribe("ready", function(){
          loadTechniker(function(val){
            JFCustomWidget.sendData({ value: val });
          });

          // Änderung des Techniker-Auswahlfeldes
          select.addEventListener('change', function(){
            JFCustomWidget.sendData({ value: select.value });
          });
        });

        // Wenn sich das Feld "dienstleister" ändert → neu laden
        JFCustomWidget.subscribe("fieldsChanged", function(data) {
          if (data && data.dienstleister !== undefined) {
            loadTechniker(function(val){
              JFCustomWidget.sendData({ value: val });
            });
          }
        });

        // Beim Absenden den aktuellen Wert zurückgeben
        JFCustomWidget.subscribe("submit", function(){
          JFCustomWidget.sendSubmit({
            valid: true,
            value: select.value
          });
        });

      })();
    </script>
  </body>
</html>
